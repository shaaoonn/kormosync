// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --------------------------------------
// Enums
// --------------------------------------

enum SubscriptionStatus {
  ACTIVE
  INACTIVE
  PAST_DUE
}

enum Role {
  SUPER_ADMIN
  OWNER
  ADMIN
  EMPLOYEE
  FREELANCER
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  REVIEW
  DONE
}

enum Priority {
  LOW
  MEDIUM
  HIGH
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
}


enum NotificationType {
  INFO
  WARNING
  ERROR
}

enum BillingType {
  FIXED_PRICE
  HOURLY
  SCHEDULED
}

enum ScheduleType {
  DAILY
  WEEKLY
  MONTHLY
}

enum TaskPublishStatus {
  DRAFT
  PUBLISHED
}

enum SubTaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
}

enum TaskAssignmentStatus {
  PENDING
  ACCEPTED
  REJECTED
}

enum LeaveType {
  PAID
  UNPAID
  SICK
  HALF_DAY
}

enum LeaveStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum AttendanceStatus {
  PRESENT
  ON_LEAVE
  ABSENT
  PARTIAL
  HOLIDAY
}

enum SalaryType {
  HOURLY
  MONTHLY
}

enum RecurringType {
  DAILY
  WEEKLY
  MONTHLY
}

enum DependencyType {
  BLOCKS
  BLOCKED_BY
}

enum CustomFieldType {
  TEXT
  NUMBER
  DROPDOWN
  DATE
}

enum ReviewAction {
  APPROVED
  REQUEST_CHANGES
}

// --------------------------------------
// Models
// --------------------------------------

model Company {
  id                  String             @id @default(uuid())
  name                String
  companySize         String?            // e.g. "1-10", "11-50"
  subscriptionStatus  SubscriptionStatus @default(ACTIVE)
  isStarred           Boolean            @default(false)
  maxEmployees        Int                @default(10)      // Default 10 for free trial? Or 10 for Startup
  subscriptionEndDate DateTime?
  aiCredits           Int                @default(50)
  bkashAgreementId    String? 

  // Storage
  storageUsed         Float              @default(0.0) // In MB
  storageLimit        Float              @default(2048.0) // 2GB Default

  // Trial Logic
  trialEmployeeEndDate DateTime?         // Free plan: employee access expires after this date
  hasClaimedTrial      Boolean           @default(false)

  // Feature Gates (Phase 5.2)
  enabledFeatures      String[]          @default(["tasks", "screenshots", "activity", "payroll"])

  // Payroll Settings
  workingDaysPerMonth  Int?                              // Custom working days per month (1-31), null = auto-calculate
  overtimeRate         Float             @default(1.5)   // Overtime multiplier (1.5x)
  defaultExpectedHours Float             @default(8.0)   // Daily expected work hours

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  // Relations
  users    User[]
  tasks    Task[]
  payments Payment[]
  invites  Invite[]
  clientTasks Task[] @relation("ClientTasks")
  leaveBalances     LeaveBalance[]
  leaveRequests     LeaveRequest[]
  dailyAttendance   DailyAttendance[]
  customFieldDefinitions CustomFieldDefinition[]

  @@index([subscriptionStatus])
}

model User {
  id          String  @id @default(uuid())
  companyId   String?
  firebaseUid String  @unique 
  role        Role    @default(EMPLOYEE)
  isPublic    Boolean @default(false)
  email       String? @unique
  name        String?
  designation String? 
  phoneNumber String?
  profileImage String?

  // CV / Profile Fields
  bio           String?   // Short bio/summary
  dateOfBirth   DateTime?
  address       String?
  city          String?
  country       String?
  skills        String[]  @default([])  // Array of skill tags
  education     Json?     // [{degree, institution, year}]
  experience    Json?     // [{title, company, startDate, endDate, description}]
  references    Json?     // [{name, position, company, phone, email}]
  
  // Social Links
  linkedIn      String?
  portfolio     String?
  facebook      String?
  youtube       String?
  twitter       String?
  github        String?

  // Payroll info
  hourlyRate          Float?      @default(0.0)
  currency            String      @default("BDT")
  salaryType          SalaryType  @default(HOURLY)
  monthlySalary       Float?      @default(0.0)
  expectedHoursPerDay Float       @default(8.0)
  minDailyHours       Float       @default(0)    // Minimum daily hours for attendance (0 = disabled)

  // Per-employee overrides (null = use company default)
  overrideWorkingDaysPerMonth  Int?
  overrideOvertimeRate         Float?
  overrideExpectedHours        Float?

  // Work schedule (HH:mm format strings)
  workStartTime    String?
  workEndTime      String?
  breakStartTime   String?
  breakEndTime     String?

  // Weekly off days (0=Sunday ... 5=Friday, 6=Saturday)
  weeklyOffDays    Int[]      @default([5])

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  // Relations
  company       Company?       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  assignedTasks Task[]         @relation("AssignedTasks")
  createdTasks  Task[]         @relation("CreatedTasks")
  timeLogs      TimeLog[]
  screenshots   Screenshot[]
  notifications Notification[]
  createdInvites Invite[]
  activityLogs  ActivityLog[]
  subTaskTimeLogs SubTaskTimeLog[]
  taskAuditLogs TaskAuditLog[]
  appUsageLogs  AppUsageLog[]
  taskAssignments TaskAssignment[]
  workProofs   WorkProof[]
  leaveRequests     LeaveRequest[]  @relation("UserLeaveRequests")
  approvedLeaves    LeaveRequest[]  @relation("ApprovedLeaves")
  leaveBalances     LeaveBalance[]
  dailyAttendance   DailyAttendance[]
  reviewerTasks     Task[]          @relation("ReviewerTasks")
  reviewComments    ReviewComment[]
  taskNotes         TaskNote[]
  taskSubmissions   TaskSubmission[]

  @@index([companyId])
  @@index([role])
  @@index([isPublic])
}

model Notification {
  id        String           @id @default(uuid())
  userId    String
  title     String
  message   String
  type      NotificationType @default(INFO)
  isRead    Boolean          @default(false)
  createdAt DateTime         @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
}

model Task {
  id          String   @id @default(uuid())
  companyId   String?
  creatorId   String
  clientId    String?  // If created by Freelancer, this links to the Client Company
  title       String
  description String?  @db.Text
  status      TaskStatus @default(IN_PROGRESS) // default was implicit, making it explicit enum
  publishStatus TaskPublishStatus @default(DRAFT)

  // Rich Task Fields
  priority         String    @default("MEDIUM") // LOW, MEDIUM, HIGH
  deadline         DateTime?
  isDraft          Boolean   @default(false)
  
  // Billing Fields (for single tasks without subtasks)
  billingType      BillingType @default(HOURLY)
  fixedPrice       Float?
  hourlyRate       Float?
  estimatedHours   Float?
  scheduleType     ScheduleType?
  scheduleDays     Int[]     @default([])
  startTime        String?   // "09:00" format (HH:mm)
  endTime          String?   // "17:00" format (HH:mm)
  allowOvertime    Boolean   @default(false) // Allow work beyond endTime?

  // Activity Threshold & Penalty (Phase 2)
  activityThreshold    Int      @default(40)    // Minimum activity % (0-100)
  penaltyEnabled       Boolean  @default(false)
  penaltyType          String?  // "DEDUCT_TIME" | "NOTIFY_ADMIN" | "PAUSE_TIMER"
  penaltyThresholdMins Int      @default(15)    // Consecutive low-activity minutes before penalty

  // Monitoring Mode (Phase 6.2)
  monitoringMode   String    @default("TRANSPARENT") // "TRANSPARENT" | "STEALTH"

  // Task Control (Admin pause/resume)
  isActive         Boolean   @default(true)    // Admin can pause/resume anytime
  pausedAt         DateTime?                   // When task was paused
  pausedReason     String?                     // Optional reason for pausing

  // Data Collection Toggles
  screenshotEnabled  Boolean @default(true)    // Take screenshots for this task?
  activityEnabled    Boolean @default(true)    // Track activity (keystrokes/clicks)?
  allowRemoteCapture Boolean @default(true)    // Admin can capture employee screen remotely

  // AI & Media Fields
  descriptionRaw   String?   @db.Text
  aiStructuredData Json?     // { subTasks: [], suggestedApps: [] }
  audioUrl         String?
  videoUrl         String?
  attachments      String[]  @default([])
  resourceLinks    String[]  @default([])
  manualAllowedApps String[] @default([])
  screenshotInterval Int      @default(5)  // Screenshot interval in minutes (1-60)

  // Dynamic Proof Builder (Sprint 11)
  proofSchema      Json?      // [{id, label, type: "TEXT"|"NUMBER"|"FILE"|"DROPDOWN"|"CHECKBOX", options?: string[], required: boolean}]
  proofFrequency   String     @default("UNLIMITED")  // "ONCE_DAILY" | "UNLIMITED"

  // Recurring Task Fields
  isRecurring      Boolean        @default(false)
  recurringType    RecurringType?
  recurringEndDate DateTime?
  recurringCount   Int?           // Max occurrences (null = unlimited until endDate)
  parentTaskId     String?        // Link to template/parent recurring task
  recurringIndex   Int?           // Which occurrence (1, 2, 3...)

  // Budget
  maxBudget        Float?         // Maximum cost limit for this task

  // Review/QA
  reviewerId       String?        // Assigned reviewer user ID

  // Employee Completion & Break Settings (Phase 10)
  employeeCanComplete   Boolean  @default(true)    // Can employee mark task as complete?
  breakReminderEnabled  Boolean  @default(false)   // Enable break reminders?
  breakAfterHours       Float    @default(2.0)     // Hours of continuous work before suggesting break

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  company     Company? @relation(fields: [companyId], references: [id], onDelete: Cascade)
  client      Company? @relation("ClientTasks", fields: [clientId], references: [id])
  creator     User     @relation("CreatedTasks", fields: [creatorId], references: [id])
  assignees   User[]   @relation("AssignedTasks")
  reviewer    User?    @relation("ReviewerTasks", fields: [reviewerId], references: [id])

  // Self-relation for recurring tasks
  parentTask  Task?    @relation("RecurringChildren", fields: [parentTaskId], references: [id], onDelete: SetNull)
  childTasks  Task[]   @relation("RecurringChildren")

  timeLogs     TimeLog[]
  subTasks     SubTask[]
  activityLogs ActivityLog[]
  screenshots  Screenshot[]
  auditLogs    TaskAuditLog[]
  appUsageLogs AppUsageLog[]
  taskAssignments TaskAssignment[]
  workProofs   WorkProof[]
  dependencies    TaskDependency[]  @relation("TaskDependencies")
  dependedOnBy    TaskDependency[]  @relation("DependsOnTask")
  checklist       TaskChecklist[]
  customFieldValues TaskCustomFieldValue[]
  reviewComments  ReviewComment[]
  taskNotes       TaskNote[]
  submissions     TaskSubmission[]

  @@index([companyId])
  @@index([status])
  @@index([publishStatus])
  @@index([parentTaskId])
}

model TimeLog {
  id              String    @id @default(uuid())
  userId          String
  taskId          String?
  startTime       DateTime
  endTime         DateTime?
  durationSeconds Int? // Calculated on finish

  // Relations
  user User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  task Task? @relation(fields: [taskId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([startTime])
}

model Screenshot {
  id            String   @id @default(uuid())
  userId        String
  taskId        String?
  subTaskId     String?  // Link to specific sub-task for bundles
  screenshotPath String   // Stores ONLY the file path (e.g., "screenshots/user1/img.png")
  activityScore Int      @default(0)
  recordedAt    DateTime @default(now())
  deviceId      String?  // Hardware fingerprint — detects multi-device usage

  // Activity metrics
  keyboardCount Int      @default(0)
  mouseCount    Int      @default(0)
  activeSeconds Int      @default(300)

  // Relations
  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  task    Task?    @relation(fields: [taskId], references: [id], onDelete: Cascade)
  subTask SubTask? @relation(fields: [subTaskId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([taskId])
  @@index([subTaskId])
  @@index([recordedAt])
}

model Payment {
  id                 String        @id @default(uuid())
  companyId          String
  trxID              String        @unique
  amount             Float
  status             PaymentStatus @default(PENDING)
  paymentExecuteTime DateTime?
  metadata           Json?         // Stores planName, maxEmployees, etc.

  createdAt DateTime @default(now())

  // Relations
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([status])
}

// Invite Token for Team Invitations
model Invite {
  id          String    @id @default(uuid())
  companyId   String
  token       String    @unique @default(uuid())
  email       String?   // If set, only this email can use the invite
  createdById String
  usedAt      DateTime? // Null = pending, Date = used
  expiresAt   DateTime? // Optional expiry
  
  createdAt   DateTime  @default(now())

  // Relations
  company     Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdBy   User      @relation(fields: [createdById], references: [id])

  @@index([companyId])
  @@index([token])
}

// Sub-Task for Task Bundles
model SubTask {
  id              String        @id @default(uuid())
  taskId          String
  title           String
  description     String?       @db.Text
  status          SubTaskStatus @default(PENDING)
  totalSeconds    Int           @default(0)  // Accumulated time
  billingType     BillingType   @default(HOURLY)
  
  // Pricing
  fixedPrice      Float?        // For FIXED_PRICE
  hourlyRate      Float?        // For HOURLY
  estimatedHours  Float?        // For HOURLY estimate
  
  // Scheduling (for SCHEDULED type)
  scheduleType    ScheduleType?
  scheduleDays    Int[]         @default([]) // 0=Sun...6=Sat OR dates 1-31 for monthly
  startTime       String?       // "09:00" format (HH:mm)
  endTime         String?       // "17:00" format (HH:mm)
  allowOvertime   Boolean       @default(false) // Allow work beyond endTime?

  orderIndex      Int           @default(0)
  createdAt       DateTime      @default(now())
  
  // Relations
  task            Task          @relation(fields: [taskId], references: [id], onDelete: Cascade)
  timeLogs        SubTaskTimeLog[]
  screenshots     Screenshot[]
  workProofs      WorkProof[]
  submissions     TaskSubmission[]

  @@index([taskId])
  @@index([status])
}

// Sub-Task Time Log for individual tracking
model SubTaskTimeLog {
  id              String    @id @default(uuid())
  subTaskId       String
  userId          String
  startTime       DateTime
  endTime         DateTime?
  durationSeconds Int?
  
  createdAt       DateTime  @default(now())
  
  // Relations
  subTask         SubTask   @relation(fields: [subTaskId], references: [id], onDelete: Cascade)
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([subTaskId])
  @@index([userId])
}

// Activity Log for 5-minute interval tracking
model ActivityLog {
  id              String   @id @default(uuid())
  userId          String
  taskId          String
  
  // 5-minute interval data
  intervalStart   DateTime
  intervalEnd     DateTime
  
  // Activity metrics
  keystrokes      Int      @default(0)
  mouseClicks     Int      @default(0)
  mouseMovement   Int      @default(0)  // total pixels moved
  activeSeconds   Int      @default(0)  // seconds with activity out of 300
  
  createdAt       DateTime @default(now())
  
  // Relations
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  task            Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  
  @@index([userId, taskId])
  @@index([intervalStart])
  @@index([userId, taskId, intervalStart])  // Composite index for filtered queries
}

// Task Audit Log - tracks all task changes (Phase 2)
model TaskAuditLog {
  id        String   @id @default(uuid())
  taskId    String
  userId    String
  action    String   // "CREATED" | "UPDATED" | "STATUS_CHANGED" | "ASSIGNED" | "DELETED"
  field     String?  // Which field changed (e.g., "status", "title", "priority")
  oldValue  String?  @db.Text
  newValue  String?  @db.Text
  createdAt DateTime @default(now())

  // Relations
  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id])

  @@index([taskId])
  @@index([userId])
  @@index([createdAt])
}

// App Usage Log - tracks which applications employees use (Phase 3)
model AppUsageLog {
  id          String   @id @default(uuid())
  userId      String
  taskId      String
  appName     String
  windowTitle String?
  durationSec Int      @default(0)
  recordedAt  DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([userId, taskId])
  @@index([recordedAt])
}

// ============================================================
// Phase 4: Payroll Engine
// ============================================================

// Pay Period - monthly billing cycle
model PayPeriod {
  id          String   @id @default(uuid())
  companyId   String
  startDate   DateTime
  endDate     DateTime
  status      String   @default("OPEN") // "OPEN" | "LOCKED" | "PAID"
  totalAmount Float    @default(0.0)
  currency    String   @default("BDT")
  createdAt   DateTime @default(now())
  closedAt    DateTime?

  invoices Invoice[]

  @@unique([companyId, startDate])
  @@index([companyId])
  @@index([status])
}

// Invoice - per-employee per-period
model Invoice {
  id            String   @id @default(uuid())
  payPeriodId   String
  userId        String
  companyId     String
  totalHours    Float    @default(0.0)
  hourlyRate    Float    @default(0.0)
  grossAmount   Float    @default(0.0)
  deductions    Float    @default(0.0) // Penalty deductions
  bonuses       Float    @default(0.0)
  netAmount     Float    @default(0.0)
  currency      String   @default("BDT")
  status        String   @default("DRAFT") // "DRAFT" | "APPROVED" | "PAID" | "CANCELLED"
  notes         String?  @db.Text
  approvedAt    DateTime?
  paidAt        DateTime?

  // Leave & Overtime breakdown
  leaveHours       Float    @default(0.0)
  leavePay         Float    @default(0.0)
  overtimeHours    Float    @default(0.0)
  overtimePay      Float    @default(0.0)
  overtimeRate     Float    @default(1.5)
  salaryType       String   @default("HOURLY") // "HOURLY" | "MONTHLY"
  monthlySalary    Float    @default(0.0)
  workedDays       Int      @default(0)
  totalWorkingDays Int      @default(0)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  payPeriod PayPeriod @relation(fields: [payPeriodId], references: [id], onDelete: Cascade)

  @@unique([payPeriodId, userId])
  @@index([userId])
  @@index([companyId])
  @@index([status])
}

// Wallet - employee earnings balance
model Wallet {
  id            String   @id @default(uuid())
  userId        String   @unique
  balance       Float    @default(0.0)
  totalEarned   Float    @default(0.0)
  totalWithdrawn Float   @default(0.0)
  currency      String   @default("BDT")
  updatedAt     DateTime @updatedAt

  transactions WalletTransaction[]

  @@index([userId])
}

// Wallet Transaction Log
model WalletTransaction {
  id          String   @id @default(uuid())
  walletId    String
  type        String   // "CREDIT" | "DEBIT" | "WITHDRAWAL"
  amount      Float
  description String?
  reference   String?  // invoiceId or payment reference
  createdAt   DateTime @default(now())

  wallet Wallet @relation(fields: [walletId], references: [id], onDelete: Cascade)

  @@index([walletId])
  @@index([createdAt])
}

// App Category - defines productivity categories for apps/URLs (Phase 3)
model AppCategory {
  id         String  @id @default(uuid())
  companyId  String? // null = global default
  appPattern String  // regex or app name pattern
  category   String  // "PRODUCTIVE" | "UNPRODUCTIVE" | "NEUTRAL"
  label      String  // Display name

  @@index([companyId])
}

// ============================================================
// Phase 7: Task Assignment Approval & Work Proofs
// ============================================================

// Task Assignment - tracks approval status for each assignee
model TaskAssignment {
  id          String               @id @default(uuid())
  taskId      String
  userId      String
  status      TaskAssignmentStatus @default(PENDING)
  assignedAt  DateTime             @default(now())
  respondedAt DateTime?

  // Relations
  task        Task  @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user        User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([taskId, userId])
  @@index([userId, status])
}

// Work Proof - employee-submitted proof during work
model WorkProof {
  id          String   @id @default(uuid())
  taskId      String
  subTaskId   String?
  userId      String
  summary     String
  notes       String?  @db.Text
  attachments String[] @default([])  // MinIO file paths
  createdAt   DateTime @default(now())

  // Relations
  task        Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  subTask     SubTask? @relation(fields: [subTaskId], references: [id], onDelete: SetNull)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@index([userId])
}

// ============================================================
// Phase 8: Leave, Attendance & Payroll Ecosystem
// ============================================================

model LeaveBalance {
  id            String   @id @default(uuid())
  userId        String
  companyId     String
  year          Int
  paidLeave     Int      @default(10)
  sickLeave     Int      @default(7)
  unpaidLeave   Int      @default(0)
  paidUsed      Int      @default(0)
  sickUsed      Int      @default(0)
  unpaidUsed    Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([userId, year])
  @@index([companyId, year])
}

model LeaveRequest {
  id             String      @id @default(uuid())
  userId         String
  companyId      String
  type           LeaveType
  startDate      DateTime
  endDate        DateTime
  totalDays      Float       // 0.5 for half day
  reason         String?     @db.Text
  status         LeaveStatus @default(PENDING)
  approvedBy     String?
  approvedAt     DateTime?
  rejectedReason String?
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  user     User    @relation("UserLeaveRequests", fields: [userId], references: [id], onDelete: Cascade)
  approver User?   @relation("ApprovedLeaves", fields: [approvedBy], references: [id])
  company  Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([userId, status])
  @@index([companyId, status])
  @@index([startDate, endDate])
}

model DailyAttendance {
  id                 String           @id @default(uuid())
  userId             String
  companyId          String
  date               DateTime         @db.Date
  status             AttendanceStatus @default(ABSENT)
  totalWorkedSeconds Int              @default(0)
  expectedSeconds    Int              @default(28800) // 8 hours default
  overtimeSeconds    Int              @default(0)
  tasksSummary       Json?            // [{taskId, taskTitle, seconds}]
  earningsToday      Float            @default(0.0)
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@index([companyId, date])
  @@index([status])
}

// ============================================================
// Phase 9: Task Dependencies, Checklist, Custom Fields, Review
// ============================================================

// Task Dependency — blocker/blocked-by relationships
model TaskDependency {
  id             String         @id @default(uuid())
  taskId         String
  dependsOnTaskId String
  type           DependencyType @default(BLOCKS)
  createdAt      DateTime       @default(now())

  task           Task           @relation("TaskDependencies", fields: [taskId], references: [id], onDelete: Cascade)
  dependsOnTask  Task           @relation("DependsOnTask", fields: [dependsOnTaskId], references: [id], onDelete: Cascade)

  @@unique([taskId, dependsOnTaskId])
  @@index([taskId])
  @@index([dependsOnTaskId])
}

// Task Checklist — lightweight to-do items within a task
model TaskChecklist {
  id          String   @id @default(uuid())
  taskId      String
  title       String
  isCompleted Boolean  @default(false)
  orderIndex  Int      @default(0)
  createdAt   DateTime @default(now())

  task        Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([taskId])
}

// Custom Field Definition — company-level field definitions
model CustomFieldDefinition {
  id        String          @id @default(uuid())
  companyId String
  name      String
  type      CustomFieldType @default(TEXT)
  options   String[]        @default([]) // For DROPDOWN type
  isActive  Boolean         @default(true)
  createdAt DateTime        @default(now())

  company   Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  values    TaskCustomFieldValue[]

  @@index([companyId])
}

// Task Custom Field Value — per-task values for custom fields
model TaskCustomFieldValue {
  id        String   @id @default(uuid())
  taskId    String
  fieldId   String
  value     String   // Stored as string, parsed by type
  createdAt DateTime @default(now())

  task      Task                  @relation(fields: [taskId], references: [id], onDelete: Cascade)
  field     CustomFieldDefinition @relation(fields: [fieldId], references: [id], onDelete: Cascade)

  @@unique([taskId, fieldId])
  @@index([taskId])
  @@index([fieldId])
}

// Review Comment — QA review history for tasks
model ReviewComment {
  id        String       @id @default(uuid())
  taskId    String
  userId    String
  action    ReviewAction
  comment   String?      @db.Text
  createdAt DateTime     @default(now())

  task      Task         @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user      User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@index([userId])
}

// ============================================================
// Phase 10: Task Notes (Work Journal)
// ============================================================

model TaskNote {
  id        String   @id @default(uuid())
  taskId    String
  subTaskId String?
  userId    String
  content   String   @db.Text
  createdAt DateTime @default(now())

  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@index([userId])
}

// ============================================================
// Sprint 11: Dynamic Proof Submissions
// ============================================================
model TaskSubmission {
  id          String   @id @default(uuid())
  taskId      String
  subTaskId   String?
  userId      String
  answers     Json     // {fieldId: value} — matches task.proofSchema field IDs
  date        String   // "YYYY-MM-DD" — for ONCE_DAILY overwrite lookup
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  task    Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  subTask SubTask? @relation(fields: [subTaskId], references: [id], onDelete: SetNull)
  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([taskId, userId, date])  // ONCE_DAILY: one entry per user per day per task
  @@index([taskId])
  @@index([userId])
}
